// This file isn't generated, but this comment is necessary to exclude it from StyleCop analysis.
// <auto-generated/>
//Apache2,  2016, WinterDev
//https://www.microsoft.com/typography/otspec/chapter2.htm
using System;
using System.Collections.Generic;
using System.IO;
using System.Text;

namespace NOpenType.Tables
{
    //Script Table and Language System Record 
    //A Script table identifies each language system that defines how to use the glyphs in a script for a particular language.
    //It also references a default language system that defines how to use the script's glyphs in the absence of language-specific knowledge.

    //A Script table begins with an offset to the Default Language System table (DefaultLangSys), 
    //which defines the set of features that regulate the default behavior of the script. 
    //Next, Language System Count (LangSysCount) defines the number of language systems (excluding the DefaultLangSys) that use the script. 
    //In addition, an array of Language System Records (LangSysRecord) defines each language system (excluding the default)
    //with an identification tag (LangSysTag) and an offset to a Language System table (LangSys). 
    //The LangSysRecord array stores the records alphabetically by LangSysTag.

    //If no language-specific script behavior is defined, the LangSysCount is set to zero (0), and no LangSysRecords are allocated.
    //-----------------------
    //Script table
    //Type 	Name 	Description
    //Offset 	DefaultLangSys 	Offset to DefaultLangSys table-from beginning of Script table-may be NULL
    //USHORT 	LangSysCount 	Number of LangSysRecords for this script-excluding the DefaultLangSys
    //struct 	LangSysRecord[LangSysCount] 	Array of LangSysRecords-listed alphabetically by LangSysTag
    //-----------------------
    //LangSysRecord
    //Type 	Name 	Description
    //Tag 	LangSysTag 	4-byte LangSysTag identifier
    //Offset 	LangSys 	Offset to LangSys table-from beginning of Script table
    //Language System Table

    //The Language System table (LangSys) identifies language-system features 
    //used to render the glyphs in a script. (The LookupOrder offset is reserved for future use.)

    //Optionally, a LangSys table may define a Required Feature Index (ReqFeatureIndex) to specify one feature as required 
    //within the context of a particular language system. For example, in the Cyrillic script,
    //the Serbian language system always renders certain glyphs differently than the Russian language system.

    //Only one feature index value can be tagged as the ReqFeatureIndex.
    //This is not a functional limitation, however, because the feature and lookup definitions in OpenType
    //Layout are structured so that one feature table can reference many glyph substitution and positioning lookups.
    //When no required features are defined, then the ReqFeatureIndex is set to 0xFFFF.

    //All other features are optional. For each optional feature,
    //a zero-based index value references a record (FeatureRecord) in the FeatureRecord array, 
    //which is stored in a Feature List table (FeatureList). 
    //The feature indices themselves (excluding the ReqFeatureIndex) are stored in arbitrary order in the FeatureIndex array.
    //The FeatureCount specifies the total number of features listed in the FeatureIndex array.

    //Features are specified in full in the FeatureList table, FeatureRecord, and Feature table, 
    //which are described later in this chapter.
    //Example 2 at the end of this chapter shows a Script table, LangSysRecord, and LangSys table used for contextual positioning in the Arabic script.
    //LangSys table
    //Type 	Name 	Description
    //Offset 	LookupOrder 	= NULL (reserved for an offset to a reordering table)
    //USHORT 	ReqFeatureIndex 	Index of a feature required for this language system- if no required features = 0xFFFF
    //USHORT 	FeatureCount 	Number of FeatureIndex values for this language system-excludes the required feature
    //USHORT 	FeatureIndex[FeatureCount] 	Array of indices into the FeatureList-in arbitrary order
    class ScriptTable
    {

        LangSysTable[] langSysTables;
        public short DefaultLangSysOffset;
        public uint scriptTag;

        public static ScriptTable CreateFrom(BinaryReader reader, long beginAt)
        {
            reader.BaseStream.Seek(beginAt, SeekOrigin.Begin);
            //
            //
            ScriptTable scriptTable = new ScriptTable();

            scriptTable.DefaultLangSysOffset = reader.ReadInt16();
            ushort langSysCount = reader.ReadUInt16();
            LangSysTable[] langSysTables = scriptTable.langSysTables = new LangSysTable[langSysCount];

            for (int i = 0; i < langSysCount; ++i)
            {
                langSysTables[i] = new LangSysTable(
                    reader.ReadUInt32(), //langSysTagIdentifier 
                    reader.ReadInt16());//offset
            }
            //-----------
            //read actual content of each table
            for (int i = 0; i < langSysCount; ++i)
            {
                LangSysTable langSysTable = langSysTables[i];
                reader.BaseStream.Seek(beginAt + langSysTable.offset, SeekOrigin.Begin);
                langSysTable.ReadFrom(reader);
            }

            return scriptTable;
        }

#if DEBUG
        public override string ToString()
        {
            return Utils.TagToString(this.scriptTag);
        }
#endif

        class LangSysTable
        {
            //The Language System table (LangSys) identifies language-system features 
            //used to render the glyphs in a script. (The LookupOrder offset is reserved for future use.)
            //
            public uint langSysTagIden { get; private set; }
            public readonly short offset;

            //
            public ushort[] featureIndexList { get; private set; }
            public ushort RequireFeatureIndex { get; private set; }

            public LangSysTable(uint langSysTagIden, short offset)
            {
                this.offset = offset;
                this.langSysTagIden = langSysTagIden;
            }
            public void ReadFrom(BinaryReader reader)
            {
                //Name 	Description
                //Offset 	LookupOrder 	= NULL (reserved for an offset to a reordering table)
                //USHORT 	ReqFeatureIndex 	Index of a feature required for this language system- if no required features = 0xFFFF
                //USHORT 	FeatureCount 	Number of FeatureIndex values for this language system-excludes the required feature
                //USHORT 	FeatureIndex[FeatureCount] 	Array of indices into the FeatureList-in arbitrary order
                short lookupOrder = reader.ReadInt16();//reserve
                RequireFeatureIndex = reader.ReadUInt16();
                ushort featureCount = reader.ReadUInt16();
                featureIndexList = Utils.ReadUInt16Array(reader, featureCount);

            }
            public bool HasRequireFeature
            {
                get { return RequireFeatureIndex != 0xFFFF; }
            }
#if DEBUG
            public override string ToString()
            {
                return Utils.TagToString(langSysTagIden);
            }
#endif

        }
    }
}